require 'func.lua'
require 'drfunc.lua'
require 'quests.lua'

thetable={} -- ??? ??????? ??? ?????? ??????
bullets ={} -- ??? ??????? ??? ???????
large   ={} -- ??? ??????? ???????. ????????, ??????? ? ??????. ? ???? ????? ????? ?????????????????.
items ={} -- ???????
images = {} -- картинки
inventory = {}
item = 1; -- ???????? ????

zavr = 1; -- ????? ? ??????? ??????? ?????, ??? ????????
money= 1000; -- ?????? 

game_state='' -- ????????

errormsg='' -- ??? ???????


AIstep = 0; -- ?? ????? ?????? ?? ?????? ???? :3


fps = 100; -- ??? ???????? ???

-- ??????:
kb = love.keyboard;
gr = love.graphics;

-- ?????? ?????????? ??????????
-- ?????? ???? ??????? ??? ???????????
wrldbk = gr.newImage('stars.png')
title = gr.newImage('title_screen.gif')


function love.load()
	

	game_state='menu'
	
-- ????????? ?????? ????
	love.graphics.setMode(800, 480)	
	love.graphics.setIcon(love.graphics.newImage('ship.png'))
	love.graphics.setCaption("SPACEZAVR! Tosha Quest")
	
	font = love.graphics.newFont("PressStartK.ttf", 8)
	love.graphics.setFont(font)
	-- загрузка в картинок в глобальный массив, чтоб работало быстрее
	images['cargo']=love.graphics.newImage('cargo.png');
	images['asteroid']=love.graphics.newImage('asteroid.png');
	images['shot']=love.graphics.newImage('shot.png')

-- ?????????? ?????? ? ???
-- ?????????? ????? add ??? ?????? ????? ????
	table.insert(thetable,zavr,{class='player',wx=0,wy=0,ox=400,oy=240,angle=0,speed=0,speedup=0,pic=love.graphics.newImage('ship.png'),alive=1,hp=100,reload=0})
-- ????????? ????????
-- ??????? ???????? ?? ?????
	table.insert(items,{name='Cargo',cost=100,quant=9999,have=0})
	table.insert(items,{name='Boxes',cost=200,quant=9999,have=0})
	table.insert(items,{name='Litters',cost=10.2,quant=9999,have=0})
	table.insert(items,{name='Razors',cost=3576,quant=9999,have=0})
	table.insert(items,{name='Need more targets',cost=1,quant=9999,have=0})
-- ?????????? ? ??? ??????? ?????
-- ??????? ???????????? ?????????
-- ????? ????? ?? ??????? ? ???????
-- ????????? ? ?????, ?????? ?? ?????, ?????? ????????
-- ?????? ??????????
--	add('cargo',0,0,0,1)
	add('cargo',75,75,2,5)
	--add('cargo',75,-75,0.75,5)
	add('cargo',-75,75,-2,5)
	--add('cargo',-75,-75,-0.75,5)
	
	--add('cargo',175,175,2,3)
	--add('cargo',175,-175,0.75,3)
	--add('cargo',-175,175,-2,3)
	--add('cargo',-175,-175,-0.75,3)
	
	add('asteroid',100,0,0,0)
	add('asteroid',145,0,0,0)
	add('asteroid',190,0,0,0)
	--add('asteroid')
	
	new_quest(0,-1000,1,1,{4,5,6},{zavr})
	
	table.insert(large,{name='Muramasa',wx=0,wy=-1000,class='planet',pic=gr.newImage('planet-1.png')})
end

function love.update(dt)

if(game_state=="space") then
-- ?????????? ????????? ?????????
	table.foreach(thetable, function(k,v) updater(v,k) end)
	table.foreach(bullets, function(k,v) bul(v,k) end)
	
	check_quests()
	
	if(thetable[zavr].speedup<0.01 and thetable[zavr].speedup > -0.01) then
	thetable[zavr].speedup = 0; -- ?????? ??????????? ??????????
	end
	
	fps = love.timer.getFPS();
	thetable[zavr].reload = thetable[zavr].reload +1;
	AIstep = AIstep +1;
	if(AIstep > 15) then AIstep = 0; end
-- ?????????? ??????	
	if kb.isDown('up') then
		thetable[zavr].speedup=thetable[zavr].speedup+0.01
	end
	if kb.isDown('down') then
		thetable[zavr].speedup=thetable[zavr].speedup-0.01
	end
	if kb.isDown('left') then
		thetable[zavr].angle=thetable[zavr].angle-0.1
	end
	if kb.isDown('right') then
		thetable[zavr].angle=thetable[zavr].angle+0.1
	end
	
	if kb.isDown(' ') then 
		-- lazor!
	if(thetable[zavr].reload >= 4) then
		table.insert(bullets,{class='shot',ox=1, oy = 1, wx=thetable[zavr].wx+math.sin(thetable[zavr].angle)*32, wy = thetable[zavr].wy - math.cos(thetable[zavr].angle)*32, angle = thetable[zavr].angle, speed = thetable[zavr].speed+2, pic = images['shot'], creation = dt, ttl = 2000, parent = thetable[zavr].class, alive = 1})
	--	thetable[zavr].speed=thetable[zavr].speed - 0.01
	thetable[zavr].reload = 0;
	end
	end
	
	
	
	
elseif (game_state=="menu") then
	if kb.isDown(' ','return') then 
		game_state = 'pause'
	end
	if kb.isDown('escape') then 
		love.event.push('q')
	end
	
	
elseif (game_state=="pause") then
	
	
	
elseif (game_state=="shop") then
	if kb.isDown('down') then
		item = item +1
		if item > table.getn(items) then
		item = 1
		end
		love.timer.sleep(100)
	end
	if kb.isDown('up') then
		item = item -1
		if item < 1 then
		item =  table.getn(items)
		end
		love.timer.sleep(100)
	end
	
elseif (game_state=="dialog") then
elseif (game_state=="quest") then
end
end

function love.keypressed(key, unicode) ---------------------- ????????? ??? ??????? ??? ?? ????? ??? ???? ?????? ??????? ?????? 
if(game_state=="space") then

	if(key == 'return') then 
		interact()
	end
	
	
	if (key == 'escape') then -- ?????????? ? love.keypressed?
		love.event.push('q')
	end
	
	if (key == '1' or key == 'P') then -- // --
		--game_state = "pause"
		love.timer.sleep(2000)
	end
	
elseif (game_state=="menu") then
	
elseif (game_state=="pause") then
	if ((key == '1') or (key == 'return') or (key == 'P') or (key == 'escape')) then 
		game_state = "space"
		--love.timer.sleep(1000)
	end
elseif (game_state=="shop") then
	if (key == ' ')then
		if(money >= items[item].cost and items[item].quant > 0) then
			 items[item].quant =  items[item].quant-1
			 items[item].have = items[item].have+1
			 money = money - items[item].cost
			 if( items[item].name == "Need more targets") then
			 	add("cargo",math.random(4048)-2024,math.random(4048)-2024,0,1)
			 end
			 
		end
	end
	if (key == 'escape') then
	game_state="space"
	end
elseif (game_state=="dialog") then
elseif (game_state=="quest") then
end
end

function love.draw()

	gr.print(fps..'FPS',760,0);

if(game_state=="space")  then	
	
	worlddraw() -- ????????? ????
	
	drawlarge() -- ?????????? ??????? ????????
	
	
	drawships() -- ????????? ????????
	
	
	drawbullets() -- ????
		
	hud() -- ?????????
	radar() -- ?????
	
	gr.print(errormsg,100,100) -- ?????????? ??????????
	errormsg=''
elseif (game_state=="menu") then
	gr.draw(title)
elseif (game_state=="pause") then
	gr.print("PAUSE",100,100)
	gr.print("arrows for movement",100,110);
	gr.print("space for shooting",100,120);
	gr.print("return for interact",100,130);
	-- ???????? ?????????
elseif (game_state=="shop") then
	--gr.print(errormsg,100,100)
	shop()
elseif (game_state=="dialog") then
elseif (game_state=="quest") then
end
end

